name: Manual Chain Trigger

on:
  workflow_dispatch:
    inputs:
      session_id:
        description: 'Existing session ID to continue (leave empty for new)'
        required: false
        default: ''
      stop_session:
        description: 'Stop the session chain'
        required: false
        type: boolean
        default: false

jobs:
  trigger:
    runs-on: ubuntu-latest
    steps:
      - name: Stop Session
        if: ${{ github.event.inputs.stop_session == 'true' }}
        run: |
          echo "Session chain stopped by user"
          echo "To start a new session, run this workflow with stop_session=false"
          exit 0

      - name: Trigger RDP Session
        if: ${{ github.event.inputs.stop_session != 'true' }}
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          SESSION_ID="${{ github.event.inputs.session_id }}"
          if [ -z "$SESSION_ID" ]; then
            SESSION_ID=$(openssl rand -hex 4)
          fi
          
          echo "Triggering RDP session: $SESSION_ID"
          
          # Use repository_dispatch with verbose output
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/dispatches \
            -d "{\"event_type\":\"chain-rdp\",\"client_payload\":{\"session_id\":\"$SESSION_ID\",\"chain_count\":0}}")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "HTTP Status: $HTTP_CODE"
          if [ -n "$BODY" ]; then
            echo "Response: $BODY"
          fi
          
          if [ "$HTTP_CODE" = "204" ]; then
            echo ""
            echo "✅ Session triggered successfully!"
            echo "Session ID: $SESSION_ID"
            echo ""
            echo "Check the Actions tab for 'Infinite RDP Session' workflow"
          else
            echo ""
            echo "❌ Failed to trigger session"
            echo "Make sure:"
            echo "  1. GH_PAT secret has 'repo' scope"
            echo "  2. rdp-session.yml has no syntax errors"
            exit 1
          fi
