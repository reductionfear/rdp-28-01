name: Infinite RDP Session

on:
  workflow_dispatch:
    inputs:
      session_id:
        description: 'Session identifier (auto-generated for chains)'
        required: false
        default: ''
      chain_count:
        description: 'Chain iteration counter'
        required: false
        default: '0'
  repository_dispatch:
    types: [chain-rdp]

env:
  SESSION_TIMEOUT_MINUTES: 330  # 5.5 hours (GitHub limit is 6h)
  CHAIN_BUFFER_MINUTES: 15     # Start new session 15 min before timeout
  PERSIST_DIR: C:\rdp-persist  # Directory for persistent data

jobs:
  rdp-session:
    runs-on: windows-latest
    timeout-minutes: 350

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate session info
        id: session
        shell: pwsh
        run: |
          $sessionId = "${{ github.event.inputs.session_id }}"
          if ([string]::IsNullOrEmpty($sessionId)) {
            $sessionId = [guid]::NewGuid().ToString().Substring(0,8)
          }
          
          $chainCountInput = "${{ github.event.inputs.chain_count }}"
          if ([string]::IsNullOrEmpty($chainCountInput)) {
            $chainCount = 0
          } else {
            $chainCount = [int]$chainCountInput
          }
          
          if ("${{ github.event_name }}" -eq "repository_dispatch") {
            $payloadCount = "${{ github.event.client_payload.chain_count }}"
            if (-not [string]::IsNullOrEmpty($payloadCount)) {
              $chainCount = [int]$payloadCount
            }
          }
          
          echo "SESSION_ID=$sessionId" >> $env:GITHUB_OUTPUT
          echo "CHAIN_COUNT=$chainCount" >> $env:GITHUB_OUTPUT
          echo "START_TIME=$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')" >> $env:GITHUB_OUTPUT
          
          Write-Host "Session ID: $sessionId"
          Write-Host "Chain iteration: $chainCount"

      # ========== TAILSCALE SETUP ==========
      - name: Install Tailscale
        shell: pwsh
        run: |
          Write-Host "Installing Tailscale..."
          
          $url = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
          $installer = "$env:TEMP\tailscale-setup.msi"
          
          Invoke-WebRequest -Uri $url -OutFile $installer -UseBasicParsing
          
          Start-Process msiexec.exe -ArgumentList "/i", $installer, "/quiet", "/norestart" -Wait
          
          $env:PATH += ";C:\Program Files\Tailscale"
          echo "C:\Program Files\Tailscale" >> $env:GITHUB_PATH
          
          Write-Host "Tailscale installed successfully"

      - name: Connect to Tailscale
        shell: pwsh
        env:
          TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
        run: |
          $sessionId = "${{ steps.session.outputs.SESSION_ID }}"
          $hostname = "gh-rdp-$sessionId"
          
          Write-Host "Connecting to Tailscale as: $hostname"
          
          Start-Service -Name "Tailscale" -ErrorAction SilentlyContinue
          Start-Sleep -Seconds 5
          
          & "C:\Program Files\Tailscale\tailscale.exe" up `
            --authkey="$env:TAILSCALE_AUTHKEY" `
            --hostname="$hostname" `
            --accept-routes `
            --accept-dns
          
          Start-Sleep -Seconds 10
          
          $status = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
          Write-Host "=========================================="
          Write-Host "TAILSCALE IP: $status"
          Write-Host "HOSTNAME: $hostname"
          Write-Host "=========================================="
          
          echo "TAILSCALE_IP=$status" >> $env:GITHUB_OUTPUT

      # ========== RDP SETUP ==========
      - name: Configure RDP Access
        shell: pwsh
        run: |
          Write-Host "Configuring RDP access..."
          
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=tcp localport=3389
          
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1
          
          Write-Host "RDP configured successfully"

      - name: Create RDP User
        shell: pwsh
        env:
          RDP_PASSWORD: ${{ secrets.RDP_PASSWORD }}
        run: |
          $username = "rdpuser"
          $password = $env:RDP_PASSWORD
          
          if ([string]::IsNullOrEmpty($password)) {
            $password = -join ((65..90) + (97..122) + (48..57) + (33,35,36,37,38,42) | Get-Random -Count 16 | ForEach-Object {[char]$_})
            Write-Host "Generated password: $password"
          }
          
          $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
          
          try {
            New-LocalUser -Name $username -Password $securePassword -FullName "RDP User" -Description "GitHub Actions RDP User" -PasswordNeverExpires
          } catch {
            Set-LocalUser -Name $username -Password $securePassword
          }
          
          Add-LocalGroupMember -Group "Administrators" -Member $username -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username -ErrorAction SilentlyContinue
          
          Write-Host "=========================================="
          Write-Host "RDP CREDENTIALS"
          Write-Host "Username: $username"
          Write-Host "Password: (check secrets or generated above)"
          Write-Host "=========================================="

      - name: Initialize rdpuser profile
        id: rdpuser
        shell: pwsh
        env:
          RDP_PASSWORD: ${{ secrets.RDP_PASSWORD }}
        run: |
          $username = "rdpuser"
          $password = $env:RDP_PASSWORD
          $persistDir = "${{ env.PERSIST_DIR }}"
          
          Write-Host "Initializing user profile for rdpuser..."
          
          New-Item -ItemType Directory -Path $persistDir -Force | Out-Null
          
          $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
          
          $initScript = @"
          Write-Host "Profile initialized for: `$env:USERNAME"
          Write-Host "USERPROFILE: `$env:USERPROFILE"
          
          New-Item -ItemType Directory -Path "`$env:USERPROFILE\Documents" -Force | Out-Null
          New-Item -ItemType Directory -Path "`$env:USERPROFILE\Desktop" -Force | Out-Null
          New-Item -ItemType Directory -Path "`$env:USERPROFILE\Downloads" -Force | Out-Null
          New-Item -ItemType Directory -Path "`$env:USERPROFILE\projects" -Force | Out-Null
          New-Item -ItemType Directory -Path "`$env:USERPROFILE\.openclaw" -Force | Out-Null
          New-Item -ItemType Directory -Path "`$env:USERPROFILE\.npm-global" -Force | Out-Null
          New-Item -ItemType Directory -Path "`$env:USERPROFILE\.local\bin" -Force | Out-Null
          New-Item -ItemType Directory -Path "`$env:USERPROFILE\openclaw-workspace" -Force | Out-Null
          
          "`$env:USERPROFILE" | Out-File -FilePath "$persistDir\actual-userprofile.txt" -Encoding UTF8 -NoNewline
          "@
          
          $initScriptPath = "$env:TEMP\init-profile.ps1"
          $initScript | Out-File -FilePath $initScriptPath -Encoding UTF8
          
          try {
            $processInfo = New-Object System.Diagnostics.ProcessStartInfo
            $processInfo.FileName = "powershell.exe"
            $processInfo.Arguments = "-ExecutionPolicy Bypass -File `"$initScriptPath`""
            $processInfo.UseShellExecute = $false
            $processInfo.LoadUserProfile = $true
            $processInfo.UserName = $username
            $processInfo.Password = $securePassword
            $processInfo.Domain = $env:COMPUTERNAME
            $processInfo.RedirectStandardOutput = $true
            $processInfo.RedirectStandardError = $true
            
            $process = [System.Diagnostics.Process]::Start($processInfo)
            $output = $process.StandardOutput.ReadToEnd()
            $errors = $process.StandardError.ReadToEnd()
            $process.WaitForExit(60000)
            
            Write-Host "Profile init output: $output"
            if ($errors) { Write-Host "Profile init errors: $errors" }
            
          } catch {
            Write-Host "Could not run as rdpuser directly: $_"
            Write-Host "Creating profile manually..."
            
            $rdpUserHome = "C:\Users\rdpuser"
            New-Item -ItemType Directory -Path $rdpUserHome -Force | Out-Null
            New-Item -ItemType Directory -Path "$rdpUserHome\Documents" -Force | Out-Null
            New-Item -ItemType Directory -Path "$rdpUserHome\Desktop" -Force | Out-Null
            New-Item -ItemType Directory -Path "$rdpUserHome\Downloads" -Force | Out-Null
            New-Item -ItemType Directory -Path "$rdpUserHome\projects" -Force | Out-Null
            New-Item -ItemType Directory -Path "$rdpUserHome\.openclaw" -Force | Out-Null
            New-Item -ItemType Directory -Path "$rdpUserHome\.npm-global" -Force | Out-Null
            New-Item -ItemType Directory -Path "$rdpUserHome\.local\bin" -Force | Out-Null
            New-Item -ItemType Directory -Path "$rdpUserHome\openclaw-workspace" -Force | Out-Null
            New-Item -ItemType Directory -Path "$rdpUserHome\AppData\Local" -Force | Out-Null
            New-Item -ItemType Directory -Path "$rdpUserHome\AppData\Roaming" -Force | Out-Null
            New-Item -ItemType Directory -Path "$rdpUserHome\AppData\Local\Temp" -Force | Out-Null
            
            $profileList = "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\ProfileList"
            $userSid = (Get-LocalUser -Name $username).SID.Value
            
            if ($userSid) {
              $profileKey = "$profileList\$userSid"
              if (-not (Test-Path $profileKey)) {
                New-Item -Path $profileKey -Force | Out-Null
              }
              Set-ItemProperty -Path $profileKey -Name "ProfileImagePath" -Value $rdpUserHome -Type ExpandString
              Set-ItemProperty -Path $profileKey -Name "State" -Value 0 -Type DWord
              Set-ItemProperty -Path $profileKey -Name "RefCount" -Value 0 -Type DWord
            }
            
            $rdpUserHome | Out-File -FilePath "$persistDir\actual-userprofile.txt" -Encoding UTF8 -NoNewline
          }
          
          $rdpUserHome = "C:\Users\rdpuser"
          if (Test-Path "$persistDir\actual-userprofile.txt") {
            $actualProfile = (Get-Content "$persistDir\actual-userprofile.txt" -Raw).Trim()
            if ($actualProfile -and (Test-Path $actualProfile)) {
              $rdpUserHome = $actualProfile
            }
          }
          
          try {
            $userSid = (Get-LocalUser -Name $username -ErrorAction SilentlyContinue).SID.Value
            if ($userSid) {
              $profileKey = "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\ProfileList\$userSid"
              if (Test-Path $profileKey) {
                $regProfile = (Get-ItemProperty -Path $profileKey -Name ProfileImagePath -ErrorAction SilentlyContinue).ProfileImagePath
                if ($regProfile -and (Test-Path $regProfile)) {
                  $rdpUserHome = $regProfile
                }
              }
            }
          } catch { }
          
          Write-Host "rdpuser USERPROFILE: $rdpUserHome"
          
          echo "RDPUSER_HOME=$rdpUserHome" >> $env:GITHUB_OUTPUT
          $rdpUserHome | Out-File -FilePath "$persistDir\rdpuser-home.txt" -Encoding UTF8 -NoNewline
          
          $null = cmd /c "icacls `"$rdpUserHome`" /grant rdpuser:(OI)(CI)F /T /Q 2>&1"
          $global:LASTEXITCODE = 0
          
          Write-Host "Profile initialization complete: $rdpUserHome"

      # ========== TRANSFER PERSISTED DATA (after we know USERPROFILE) ==========
      - name: Transfer persisted data to rdpuser
        shell: pwsh
        run: |
          $persistDir = "${{ env.PERSIST_DIR }}"
          $rdpUserHome = "${{ steps.rdpuser.outputs.RDPUSER_HOME }}"
          
          Write-Host "Transferring persisted data to: $rdpUserHome"
          
          # Find zip to restore
          $zipToRestore = $null
          if (Test-Path "$persistDir\userdata.zip") {
            $zipToRestore = "$persistDir\userdata.zip"
          } else {
            $zips = Get-ChildItem -Path $persistDir -Filter "userdata*.zip" -ErrorAction SilentlyContinue | Sort-Object LastWriteTime -Descending
            if ($zips.Count -gt 0) {
              $zipToRestore = $zips[0].FullName
              Write-Host "Using timestamped zip: $($zips[0].Name)"
            }
          }
          
          if (-not $zipToRestore -or -not (Test-Path $zipToRestore)) {
            Write-Host "No persisted data found (first session or artifact expired)"
            exit 0
          }
          
          Write-Host "Restoring from: $zipToRestore"
          
          # Read old USERPROFILE path
          $oldUserHome = ""
          if (Test-Path "$persistDir\userprofile.txt") {
            $oldUserHome = (Get-Content "$persistDir\userprofile.txt" -Raw).Trim()
            Write-Host "Previous session USERPROFILE: $oldUserHome"
          }
          
          # Extract to rdpuser profile
          Expand-Archive -Path $zipToRestore -DestinationPath $rdpUserHome -Force
          
          Write-Host "Data extracted to $rdpUserHome"
          
          # Paths to replace
          $pathsToReplace = @(
            "C:\Users\runneradmin",
            "C:\Users\runner",
            "C:\Users\ContainerAdministrator"
          )
          
          if ($oldUserHome -and ($oldUserHome -ne $rdpUserHome) -and ($pathsToReplace -notcontains $oldUserHome)) {
            $pathsToReplace += $oldUserHome
          }
          
          Write-Host "Patching paths to $rdpUserHome :"
          $pathsToReplace | ForEach-Object { Write-Host "  - $_" }
          
          # Find all JSON files in .openclaw to patch
          $configFiles = @()
          if (Test-Path "$rdpUserHome\.openclaw") {
            Get-ChildItem -Path "$rdpUserHome\.openclaw" -Filter "*.json" -Recurse -ErrorAction SilentlyContinue | ForEach-Object {
              $configFiles += $_.FullName
            }
          }
          
          # Add other config files
          $configFiles += "$rdpUserHome\.npmrc"
          $configFiles += "$rdpUserHome\.gitconfig"
          
          foreach ($file in $configFiles) {
            if (Test-Path $file) {
              $content = Get-Content $file -Raw -ErrorAction SilentlyContinue
              if ($content) {
                $patched = $false
                
                foreach ($oldPath in $pathsToReplace) {
                  $oldBackslash = $oldPath
                  $oldForward = $oldPath -replace '\\', '/'
                  $oldEscaped = $oldPath -replace '\\', '\\\\'
                  
                  $newBackslash = $rdpUserHome
                  $newForward = $rdpUserHome -replace '\\', '/'
                  $newEscaped = $rdpUserHome -replace '\\', '\\\\'
                  
                  if ($content.Contains($oldBackslash) -or $content.Contains($oldForward) -or $content.Contains($oldEscaped)) {
                    $content = $content -replace [regex]::Escape($oldEscaped), $newEscaped
                    $content = $content -replace [regex]::Escape($oldBackslash), $newBackslash
                    $content = $content -replace [regex]::Escape($oldForward), $newForward
                    $patched = $true
                    Write-Host "  Patched: $file"
                  }
                }
                
                if ($patched) {
                  Set-Content -Path $file -Value $content -NoNewline
                }
              }
            }
          }
          
          # Set ownership
          $null = cmd /c "icacls `"$rdpUserHome`" /grant rdpuser:(OI)(CI)F /T /Q 2>&1"
          $global:LASTEXITCODE = 0
          
          Write-Host "Restored contents:"
          Get-ChildItem -Path $rdpUserHome -Force | ForEach-Object { Write-Host "  $_" }

      - name: Configure environment for rdpuser
        shell: pwsh
        run: |
          $rdpUserHome = "${{ steps.rdpuser.outputs.RDPUSER_HOME }}"
          
          Write-Host "Configuring environment for rdpuser: $rdpUserHome"
          
          # Create directories
          New-Item -ItemType Directory -Path "$rdpUserHome\projects" -Force | Out-Null
          New-Item -ItemType Directory -Path "$rdpUserHome\.openclaw" -Force | Out-Null
          New-Item -ItemType Directory -Path "$rdpUserHome\.npm-global" -Force | Out-Null
          New-Item -ItemType Directory -Path "$rdpUserHome\openclaw-workspace" -Force | Out-Null
          New-Item -ItemType Directory -Path "$rdpUserHome\AppData\Roaming" -Force | Out-Null
          New-Item -ItemType Directory -Path "$rdpUserHome\AppData\Local" -Force | Out-Null
          New-Item -ItemType Directory -Path "$rdpUserHome\.local\bin" -Force | Out-Null
          
          # Set machine-wide environment variables
          [Environment]::SetEnvironmentVariable("OPENCLAW_STATE_DIR", "$rdpUserHome\.openclaw", "Machine")
          [Environment]::SetEnvironmentVariable("OPENCLAW_WORKSPACE", "$rdpUserHome\openclaw-workspace", "Machine")
          [Environment]::SetEnvironmentVariable("NPM_CONFIG_PREFIX", "$rdpUserHome\.npm-global", "Machine")
          
          # Update PATH
          $currentPath = [Environment]::GetEnvironmentVariable("Path", "Machine")
          $newPaths = @(
            "$rdpUserHome\.npm-global",
            "$rdpUserHome\.local\bin"
          )
          foreach ($p in $newPaths) {
            if ($currentPath -notlike "*$p*") {
              $currentPath = "$p;$currentPath"
            }
          }
          [Environment]::SetEnvironmentVariable("Path", $currentPath, "Machine")
          
          $null = cmd /c "icacls `"$rdpUserHome`" /grant rdpuser:(OI)(CI)F /T /Q 2>&1"
          $global:LASTEXITCODE = 0
          
          Write-Host "Environment configured:"
          Write-Host "  OPENCLAW_STATE_DIR = $rdpUserHome\.openclaw"
          Write-Host "  OPENCLAW_WORKSPACE = $rdpUserHome\openclaw-workspace"
          Write-Host "  NPM_CONFIG_PREFIX = $rdpUserHome\.npm-global"

      - name: Install Development Tools
        shell: pwsh
        run: |
          Write-Host "Installing development tools..."
          
          Set-ExecutionPolicy Bypass -Scope Process -Force
          [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
          iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
          
          $env:PATH = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
          
          choco install -y git vscode nodejs-lts python3 7zip --no-progress
          
          $env:PATH = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
          
          Write-Host "Development tools installed"

      - name: Configure NPM for rdpuser global installs
        shell: pwsh
        run: |
          $rdpUserHome = "${{ steps.rdpuser.outputs.RDPUSER_HOME }}"
          $npmGlobalDir = "$rdpUserHome\.npm-global"
          
          Write-Host "Configuring NPM for rdpuser: $rdpUserHome"
          
          New-Item -ItemType Directory -Path $npmGlobalDir -Force | Out-Null
          
          $env:NPM_CONFIG_PREFIX = $npmGlobalDir
          $env:PATH = "$npmGlobalDir;$env:PATH"
          
          Write-Host "NPM version: $(npm --version)"
          Write-Host "NPM prefix: $(npm config get prefix)"

      - name: Restore npm global packages from list
        shell: pwsh
        run: |
          $rdpUserHome = "${{ steps.rdpuser.outputs.RDPUSER_HOME }}"
          $npmListFile = "$rdpUserHome\.npm-global\installed-packages.txt"
          
          $env:NPM_CONFIG_PREFIX = "$rdpUserHome\.npm-global"
          $env:PATH = "$rdpUserHome\.npm-global;$env:PATH"
          
          if (Test-Path $npmListFile) {
            Write-Host "Reinstalling npm global packages from previous session..."
            
            $content = Get-Content $npmListFile -Raw
            $packages = $content -split "`n" | Where-Object { $_ -match '[+`]--\s+(\S+)@' } | ForEach-Object {
              if ($_ -match '[+`]--\s+(\S+)@') { $matches[1] }
            } | Where-Object { $_ -and $_ -ne "npm" }
            
            foreach ($pkg in $packages) {
              Write-Host "  Installing: $pkg"
              npm install -g $pkg 2>$null
            }
            
            Write-Host "NPM packages restored"
          } else {
            Write-Host "No npm packages list found, installing openclaw..."
            npm install -g openclaw@latest
          }
          
          if (-not (Get-Command openclaw -ErrorAction SilentlyContinue)) {
            Write-Host "Installing openclaw..."
            npm install -g openclaw@latest
          }
          
          $null = cmd /c "icacls `"$rdpUserHome\.npm-global`" /grant rdpuser:(OI)(CI)F /T /Q 2>&1"
          $global:LASTEXITCODE = 0

      - name: Configure OpenClaw
        shell: pwsh
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        run: |
          $rdpUserHome = "${{ steps.rdpuser.outputs.RDPUSER_HOME }}"
          $openclawDir = "$rdpUserHome\.openclaw"
          $openclawWorkspace = "$rdpUserHome\openclaw-workspace"
          
          if (Test-Path "$openclawDir\openclaw.json") {
            Write-Host "OpenClaw already configured (restored from previous session)"
            exit 0
          }
          
          Write-Host "Pre-configuring OpenClaw..."
          
          New-Item -ItemType Directory -Path $openclawDir -Force | Out-Null
          New-Item -ItemType Directory -Path "$openclawDir\agents\main\agent" -Force | Out-Null
          New-Item -ItemType Directory -Path "$openclawDir\credentials" -Force | Out-Null
          New-Item -ItemType Directory -Path $openclawWorkspace -Force | Out-Null
          
          $workspacePath = $openclawWorkspace -replace '\\', '/'
          
          $configJson = '{
            "channels": {
              "telegram": {
                "enabled": true
              }
            },
            "agents": {
              "defaults": {
                "workspace": "' + $workspacePath + '",
                "model": "claude-sonnet",
                "provider": "antigravity"
              }
            },
            "auth": {
              "order": {
                "claude-sonnet": ["antigravity", "anthropic"],
                "claude-opus": ["antigravity", "anthropic"],
                "default": ["antigravity", "anthropic", "openai"]
              }
            }
          }'
          
          $configJson | Out-File -FilePath "$openclawDir\openclaw.json" -Encoding UTF8
          Write-Host "Created openclaw.json"
          
          [Environment]::SetEnvironmentVariable("TELEGRAM_BOT_TOKEN", "$env:TELEGRAM_BOT_TOKEN", "Machine")
          Write-Host "Set TELEGRAM_BOT_TOKEN environment variable"
          
          $agentsContent = "You are a helpful AI assistant running on a GitHub Actions RDP session."
          $agentsContent | Out-File -FilePath "$openclawWorkspace\AGENTS.md" -Encoding UTF8
          
          $authProfilesJson = '{"profiles": {}, "version": 1}'
          $authProfilesJson | Out-File -FilePath "$openclawDir\agents\main\agent\auth-profiles.json" -Encoding UTF8
          
          $null = cmd /c "icacls `"$openclawDir`" /grant rdpuser:(OI)(CI)F /T /Q 2>&1"
          $null = cmd /c "icacls `"$openclawWorkspace`" /grant rdpuser:(OI)(CI)F /T /Q 2>&1"
          $global:LASTEXITCODE = 0
          
          Write-Host ""
          Write-Host "=============================================="
          Write-Host "OpenClaw pre-configured!"
          Write-Host "=============================================="
          Write-Host "Telegram: Ready (token from secrets)"
          Write-Host ""
          Write-Host "AFTER CONNECTING VIA RDP, run:"
          Write-Host "  openclaw models auth login --provider antigravity"
          Write-Host ""
          Write-Host "Then start the gateway:"
          Write-Host "  openclaw gateway"
          Write-Host "=============================================="
          
      - name: Start OpenClaw gateway
        shell: pwsh
        run: |
          $rdpUserHome = "${{ steps.rdpuser.outputs.RDPUSER_HOME }}"
          
          $env:NPM_CONFIG_PREFIX = "$rdpUserHome\.npm-global"
          $env:PM2_HOME = "$rdpUserHome\.pm2"
          
          # Function to restore patched file
          function Restore-PatchedFiles {
            $patchedSrc = "$rdpUserHome\.npm-global\patched-files\google-gemini-cli.js"
            $targetPath = "$rdpUserHome\.npm-global\node_modules\openclaw\node_modules\@mariozechner\pi-ai\dist\providers\google-gemini-cli.js"
            
            if ((Test-Path $patchedSrc) -and (Test-Path (Split-Path $targetPath -Parent))) {
              Copy-Item -Path $patchedSrc -Destination $targetPath -Force
              Write-Host "  Restored patched Antigravity user-agent"
            }
          }
          
          $startScript = "$rdpUserHome\openclaw-workspace\start-openclaw.ps1"
          
          if (Test-Path $startScript) {
            Write-Host "Running OpenClaw startup script..."
            & powershell.exe -ExecutionPolicy Bypass -File $startScript
          } else {
            Write-Host "No startup script found, starting processes directly..."
            
            # Ensure pm2 is installed
            if (-not (Test-Path "$rdpUserHome\.npm-global\pm2.cmd")) {
              npm install -g pm2
            }
            
            # Ensure openclaw is installed
            if (-not (Test-Path "$rdpUserHome\.npm-global\openclaw.cmd")) {
              npm install -g openclaw@latest
              Restore-PatchedFiles
            }
            
            # Create gateway wrapper
            $wrapper = "$rdpUserHome\openclaw-workspace\start-gateway.js"
            if (-not (Test-Path $wrapper)) {
              @"
          const { spawn } = require('child_process');
          const cmd = spawn('openclaw.cmd', ['gateway'], {
            cwd: process.cwd(),
            stdio: 'inherit',
            shell: true,
            env: { ...process.env, PM2_HOME: 'C:\\Users\\rdpuser\\.pm2' }
          });
          cmd.on('exit', (code) => process.exit(code || 0));
          "@ | Out-File -FilePath $wrapper -Encoding UTF8
            }
            
            # Stop old processes and start fresh
            & "$rdpUserHome\.npm-global\pm2.cmd" delete all 2>$null
            
            # === PROCESS 0: OPENCLAW ===
            & "$rdpUserHome\.npm-global\pm2.cmd" start $wrapper --name openclaw
            
            # === PROCESS 1: WATCHDOG ===
            $watchdogScript = "$rdpUserHome\openclaw-workspace\survival-watchdog.js"
            if (Test-Path $watchdogScript) {
              & "$rdpUserHome\.npm-global\pm2.cmd" start $watchdogScript --name watchdog
              Write-Host "Watchdog started as Process 1"
            } else {
              Write-Host "WARNING: survival-watchdog.js not found!"
            }
            
            & "$rdpUserHome\.npm-global\pm2.cmd" save
          }
          
          Write-Host ""
          Write-Host "PM2 Process Status:"
          & "$rdpUserHome\.npm-global\pm2.cmd" status
          Write-Host ""
          Write-Host "Process 0: openclaw (Gateway)"
          Write-Host "Process 1: watchdog (Survival Script)"

      - name: Display Connection Info
        id: connection
        shell: pwsh
        run: |
          $tailscaleIp = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
          $sessionId = "${{ steps.session.outputs.SESSION_ID }}"
          $chainCount = "${{ steps.session.outputs.CHAIN_COUNT }}"
          $rdpUserHome = "${{ steps.rdpuser.outputs.RDPUSER_HOME }}"
          
          Write-Host ""
          Write-Host "=============================================="
          Write-Host "       RDP SESSION READY"
          Write-Host "=============================================="
          Write-Host ""
          Write-Host "Session ID:    $sessionId"
          Write-Host "Chain Count:   $chainCount"
          Write-Host "Tailscale IP:  $tailscaleIp"
          Write-Host "Hostname:      gh-rdp-$sessionId"
          Write-Host ""
          Write-Host "Connect via RDP:"
          Write-Host "  Address:  $tailscaleIp:3389"
          Write-Host "  -or-      gh-rdp-$sessionId:3389"
          Write-Host "  Username: rdpuser"
          Write-Host "  Password: (from RDP_PASSWORD secret)"
          Write-Host ""
          Write-Host "rdpuser profile path: $rdpUserHome"
          Write-Host ""
          Write-Host "OpenClaw:"
          Write-Host "  Config: $rdpUserHome\.openclaw\openclaw.json"
          Write-Host "  Workspace: $rdpUserHome\openclaw-workspace"
          Write-Host "  Start: openclaw gateway"
          Write-Host ""
          Write-Host "Persistent directories:"
          Write-Host "  $rdpUserHome\.openclaw (config, oauth, sessions)"
          Write-Host "  $rdpUserHome\openclaw-workspace (workspace)"
          Write-Host "  $rdpUserHome\projects"
          Write-Host "  $rdpUserHome\.npm-global"
          Write-Host ""
          Write-Host "Session will auto-chain in ~${{ env.SESSION_TIMEOUT_MINUTES }} minutes"
          Write-Host "=============================================="

      # ========== AUTO-SAVE SCHEDULER ==========
      - name: Setup auto-save scheduled task
        shell: pwsh
        run: |
          $persistDir = "${{ env.PERSIST_DIR }}"
          $rdpUserHome = "${{ steps.rdpuser.outputs.RDPUSER_HOME }}"
          
          Write-Host "Setting up auto-save for: $rdpUserHome"
          
          # Store rdpuser's USERPROFILE for next session
          $rdpUserHome | Out-File -FilePath "$persistDir\userprofile.txt" -Encoding UTF8 -NoNewline
          
          # Create save script
          $saveScript = @"
          `$persistDir = "$persistDir"
          `$userHome = "$rdpUserHome"
          `$timestamp = Get-Date -Format "yyyy-MM-dd_HH-mm-ss"
          
          Write-Host "[`$timestamp] Auto-saving rdpuser data from `$userHome..."
          
          `$tempBackup = "`$env:TEMP\rdp-backup-`$timestamp"
          New-Item -ItemType Directory -Path `$tempBackup -Force | Out-Null
          
          # === OPENCLAW - FULL SAVE (critical auth + sessions) ===
          if (Test-Path "`$userHome\.openclaw") {
            Write-Host "  Saving .openclaw (openclaw config, oauth, sessions)..."
            Copy-Item -Path "`$userHome\.openclaw" -Destination "`$tempBackup\.openclaw" -Recurse -Force -ErrorAction SilentlyContinue
            Write-Host "  Saved: .openclaw (full)"
          }
          
          # === OPENCLAW WORKSPACE (agent identity, memory) ===
          if (Test-Path "`$userHome\openclaw-workspace") {
            Write-Host "  Saving openclaw-workspace (AGENTS.md, MEMORY.md, etc.)..."
            Copy-Item -Path "`$userHome\openclaw-workspace" -Destination "`$tempBackup\openclaw-workspace" -Recurse -Force -ErrorAction SilentlyContinue
            Write-Host "  Saved: openclaw-workspace (full)"
          }
          
          # === SELECTIVE NPM-GLOBAL SAVE ===
          if (Test-Path "`$userHome\.npm-global") {
            New-Item -ItemType Directory -Path "`$tempBackup\.npm-global" -Force | Out-Null
            
            Get-ChildItem -Path "`$userHome\.npm-global" -File -ErrorAction SilentlyContinue | Copy-Item -Destination "`$tempBackup\.npm-global\" -Force

            if (Test-Path "`$userHome\.npm-global\patched-files") {
              Copy-Item -Path "`$userHome\.npm-global\patched-files" -Destination "`$tempBackup\.npm-global\patched-files" -Recurse -Force
              Write-Host " Saved: npm-global\patched-files (Antigravity Patch)"
            }
            
            `$npmList = npm list -g --depth=0 2>`$null | Out-String
            `$npmList | Out-File -FilePath "`$tempBackup\.npm-global\installed-packages.txt" -Encoding UTF8
            Write-Host "  Saved: npm global packages list"
            
            if (Test-Path "`$userHome\.npm-global\package.json") {
              Copy-Item -Path "`$userHome\.npm-global\package.json" -Destination "`$tempBackup\.npm-global\" -Force
            }
          }
          
          # === USER DATA (small, always save fully) ===
          `$smallDirs = @(
            "`$userHome\projects",
            "`$userHome\Documents",
            "`$userHome\Desktop",
            "`$userHome\.ssh",
            "`$userHome\.gitconfig",
            "`$userHome\.local",
            "`$userHome\.npmrc",
            "`$userHome\.config",
            "`$userHome\.vscode"
          )
          
          foreach (`$dir in `$smallDirs) {
            if (Test-Path `$dir) {
              `$name = Split-Path `$dir -Leaf
              Copy-Item -Path `$dir -Destination "`$tempBackup\`$name" -Recurse -Force -ErrorAction SilentlyContinue
              Write-Host "  Saved: `$name"
            }
          }
          
          # === CREATE ZIP ===
          if (Test-Path "`$tempBackup\*") {
            `$tempZip = "`$persistDir\userdata-`$timestamp.zip"
            `$finalZip = "`$persistDir\userdata.zip"
            
            Compress-Archive -Path "`$tempBackup\*" -DestinationPath `$tempZip -Force
            
            `$zipSize = (Get-Item `$tempZip).Length / 1MB
            Write-Host "  Zip size: `$([math]::Round(`$zipSize, 2)) MB"
            
            if (Test-Path `$finalZip) {
              Remove-Item -Path `$finalZip -Force -ErrorAction SilentlyContinue
            }
            
            if (-not (Test-Path `$finalZip)) {
              Move-Item -Path `$tempZip -Destination `$finalZip -Force
            }

            try {
              $env:GH_TOKEN = "${{ secrets.GH_PAT }}"
              gh release delete-asset rdp-backup userdata.zip --yes 2>$null
              gh release upload rdp-backup "$persistDir\userdata.zip" --clobber
              Write-Host "  Synced to GitHub Release"
            } catch {
              Write-Host "  Could not sync to release (will sync on exit)"
            }
          }
          
          Remove-Item -Path `$tempBackup -Recurse -Force -ErrorAction SilentlyContinue
          Write-Host "[`$(Get-Date -Format 'HH:mm:ss')] Save complete"
          "@
          
          $saveScriptPath = "$persistDir\auto-save.ps1"
          $saveScript | Out-File -FilePath $saveScriptPath -Encoding UTF8
          
          # Schedule auto-save every 30 minutes
          $action = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-ExecutionPolicy Bypass -File `"$saveScriptPath`""
          $trigger = New-ScheduledTaskTrigger -Once -At (Get-Date).AddMinutes(5) -RepetitionInterval (New-TimeSpan -Minutes 30)
          $settings = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries
          
          Register-ScheduledTask -TaskName "RDPAutoSave" -Action $action -Trigger $trigger -Settings $settings -Force
          
          Write-Host "Auto-save scheduled every 30 minutes"

      - name: Schedule chain trigger
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          $chainMinutes = ${{ env.SESSION_TIMEOUT_MINUTES }} - ${{ env.CHAIN_BUFFER_MINUTES }}
          $persistDir = "${{ env.PERSIST_DIR }}"
          
          Write-Host "Chain trigger scheduled in $chainMinutes minutes"
          
          $script = @"
          Write-Host "Running final data save before chain..."
          & powershell.exe -ExecutionPolicy Bypass -File "$persistDir\auto-save.ps1"
          
          Start-Sleep -Seconds 10
          
          `$headers = @{
            "Authorization" = "Bearer ${{ secrets.GH_PAT }}"
            "Accept" = "application/vnd.github.v3+json"
          }
          
          `$body = @{
            event_type = "chain-rdp"
            client_payload = @{
              session_id = "${{ steps.session.outputs.SESSION_ID }}"
              chain_count = $([int]"${{ steps.session.outputs.CHAIN_COUNT }}" + 1)
            }
          } | ConvertTo-Json
          
          Invoke-RestMethod -Uri "https://api.github.com/repos/${{ github.repository }}/dispatches" -Method Post -Headers `$headers -Body `$body -ContentType "application/json"
          Write-Host "Next session triggered!"
          "@
          
          $scriptPath = "$env:TEMP\chain-trigger.ps1"
          $script | Out-File -FilePath $scriptPath -Encoding UTF8
          
          $triggerTime = (Get-Date).AddMinutes($chainMinutes)
          $action = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-ExecutionPolicy Bypass -File `"$scriptPath`""
          $trigger = New-ScheduledTaskTrigger -Once -At $triggerTime
          $settings = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries
          
          Register-ScheduledTask -TaskName "ChainRDP" -Action $action -Trigger $trigger -Settings $settings -Force
          
          Write-Host "Chain scheduled for: $triggerTime"

      - name: Keep session alive
        shell: pwsh
        run: |
          $endTime = (Get-Date).AddMinutes(${{ env.SESSION_TIMEOUT_MINUTES }})
      
          # Safety net: restart OpenClaw after 8 minutes
          Start-Job -ScriptBlock {
            Start-Sleep -Seconds 480
            $env:PM2_HOME = "C:\Users\rdpuser\.pm2"
            $env:PATH = "C:\Users\rdpuser\.npm-global;$env:PATH"
            $wrapper = "C:\Users\rdpuser\openclaw-workspace\start-gateway.js"
            
            & "C:\Users\rdpuser\.npm-global\pm2.cmd" restart openclaw 2>$null
            if ($LASTEXITCODE -ne 0) {
              & "C:\Users\rdpuser\.npm-global\pm2.cmd" start $wrapper --name openclaw 2>$null
            }
      [...]
