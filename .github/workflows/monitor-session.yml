name: Session Monitor

on:
  schedule:
    - cron: '*/30 * * * *'  # Every 30 minutes
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Check Active Sessions
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "Checking for active RDP sessions..."
          
          # Get running workflows
          RUNNING=$(gh run list --repo ${{ github.repository }} \
            --workflow=rdp-session.yml \
            --status=in_progress \
            --json databaseId,createdAt,displayTitle \
            --limit 5)
          
          echo "Active sessions:"
          echo "$RUNNING" | jq -r '.[] | "  - \(.displayTitle) (started: \(.createdAt))"'
          
          COUNT=$(echo "$RUNNING" | jq length)
          echo ""
          echo "Total active sessions: $COUNT"
          
          if [ "$COUNT" -eq "0" ]; then
            echo ""
            echo "No active sessions. Run the trigger-rdp workflow to start one."
          fi

      - name: Session Statistics
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo ""
          echo "=== Session Statistics (Last 24h) ==="
          
          # Count completed chains
          COMPLETED=$(gh run list --repo ${{ github.repository }} \
            --workflow=rdp-session.yml \
            --status=completed \
            --created=">=$(date -d '24 hours ago' -Iseconds)" \
            --json databaseId \
            --limit 100 | jq length)
          
          FAILED=$(gh run list --repo ${{ github.repository }} \
            --workflow=rdp-session.yml \
            --status=failure \
            --created=">=$(date -d '24 hours ago' -Iseconds)" \
            --json databaseId \
            --limit 100 | jq length)
          
          echo "Completed chains: $COMPLETED"
          echo "Failed chains: $FAILED"
